<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Terraforming Mars ‚Äî Tulosseuranta</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* ---- DESIGN TOKENS ---- */
  :root {
    --bg:         #0a0d14;
    --surface:    #111520;
    --surface2:   #161c2e;
    --border:     #1e2a45;
    --mars:       #c0440a;
    --mars2:      #e85d1a;
    --gold:       #f5a623;
    --green:      #2ecc71;
    --text:       #e8eaf0;
    --muted:      #6b7a99;
    --glow:       rgba(192,68,10,0.3);
    --radius-sm:  8px;
    --radius-md:  12px;
    --radius-lg:  16px;
    --radius-xl:  20px;
  }

  /* ---- RESET ---- */
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Exo 2',sans-serif; min-height:100vh; overflow-x:hidden; }

  /* ---- STARFIELD ---- */
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 40% 20%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 55% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 70% 35%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 85% 60%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 92% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at  5% 80%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(2px 2px at 20% 55%, rgba(255,200,150,0.4) 0%, transparent 100%),
      radial-gradient(150px 150px at 80% 20%, rgba(192,68,10,0.08) 0%, transparent 100%);
  }

  .app { position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:0 20px 60px; }

  /* ---- HEADER ---- */
  header { text-align:center; padding:40px 0 30px; }
  header::after { content:''; display:block; width:200px; height:2px; margin:16px auto 0; background:linear-gradient(90deg,transparent,var(--mars),transparent); }
  .planet {
    width:60px; height:60px; border-radius:50%; margin:0 auto 14px;
    background:radial-gradient(circle at 35% 35%,#e87a3a,#c0440a 50%,#6b1a02);
    box-shadow:0 0 40px var(--glow),inset -10px -10px 20px rgba(0,0,0,0.5);
    animation:pulse 4s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{box-shadow:0 0 40px var(--glow)} 50%{box-shadow:0 0 70px rgba(232,93,26,0.5)} }
  .logo     { font-family:'Orbitron',monospace; font-size:clamp(20px,5vw,38px); font-weight:900; letter-spacing:3px; text-transform:uppercase; background:linear-gradient(135deg,var(--mars2),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .logo-sub { font-family:'Orbitron',monospace; font-size:11px; letter-spacing:6px; color:var(--muted); text-transform:uppercase; margin-top:4px; }

  /* ---- AUTH BAR ---- */
  .auth-bar { display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-bottom:12px; font-size:13px; }
  .auth-status { color:var(--muted); }
  .auth-status.logged-in { color:var(--green); }
  .btn-auth { background:var(--surface2); border:1px solid var(--border); color:var(--muted); padding:6px 14px; border-radius:var(--radius-sm); font-family:'Exo 2',sans-serif; font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .btn-auth:hover { border-color:var(--muted); color:var(--text); }
  .btn-auth.logout { border-color:rgba(192,68,10,0.4); color:var(--mars2); }

  /* ---- TABS ---- */
  .tabs { display:flex; gap:4px; flex-wrap:wrap; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-md); padding:4px; margin-bottom:24px; }
  .tab { flex:1; min-width:90px; padding:9px 14px; background:transparent; border:none; color:var(--muted); font-family:'Exo 2',sans-serif; font-size:12px; font-weight:600; letter-spacing:0.5px; cursor:pointer; border-radius:9px; transition:all 0.2s; text-transform:uppercase; }
  .tab:hover { color:var(--text); background:var(--surface2); }
  .tab.active { background:linear-gradient(135deg,var(--mars),#8b2500); color:white; box-shadow:0 2px 12px var(--glow); }
  .tab.admin-only { display:none; }
  .tab.admin-only.visible { display:block; }

  /* ---- PANELS ---- */
  .panel { display:none; }
  .panel.active { display:block; animation:fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  /* ---- CARDS ---- */
  .card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:24px; margin-bottom:20px; }
  .card-title { font-family:'Orbitron',monospace; font-size:13px; letter-spacing:2px; color:var(--mars2); text-transform:uppercase; margin-bottom:18px; display:flex; align-items:center; gap:8px; }
  .card-title::before { content:''; display:inline-block; width:4px; height:16px; background:var(--mars2); border-radius:2px; }

  /* ---- BUTTONS ---- */
  .btn { background:linear-gradient(135deg,var(--mars),#8b2500); color:white; border:none; border-radius:10px; padding:11px 24px; font-family:'Orbitron',monospace; font-size:11px; letter-spacing:1px; text-transform:uppercase; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 15px var(--glow); }
  .btn:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 6px 20px var(--glow); }
  .btn:active { transform:translateY(0); }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-secondary { background:var(--surface2); box-shadow:none; border:1px solid var(--border); color:var(--text); }
  .btn-secondary:hover:not(:disabled) { background:var(--border); box-shadow:none; }
  .btn-danger { background:linear-gradient(135deg,#c0392b,#7b1a14); box-shadow:none; }

  /* ---- FILTER & SORT BUTTONS ---- */
  .btn-row { display:flex; gap:6px; flex-wrap:wrap; }
  .filter-btn, .sort-btn {
    background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm);
    color:var(--muted); font-family:'Exo 2',sans-serif; font-size:12px; font-weight:600;
    cursor:pointer; transition:all 0.2s; white-space:nowrap;
  }
  .filter-btn { padding:6px 14px; }
  .sort-btn   { padding:5px 12px; }
  .filter-btn:hover, .sort-btn:hover { border-color:var(--muted); color:var(--text); }
  .filter-btn.active { background:linear-gradient(135deg,var(--mars),#8b2500); border-color:var(--mars); color:white; box-shadow:0 2px 8px var(--glow); }
  .sort-btn.active   { border-color:var(--mars2); color:var(--mars2); }

  /* ---- FORM ---- */
  .form-grid   { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; margin-bottom:16px; }
  .field-group { display:flex; flex-direction:column; gap:4px; }
  .field-label { font-size:11px; font-weight:600; letter-spacing:0.5px; color:var(--muted); text-transform:uppercase; }
  .field-input { background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; color:var(--text); font-family:'Exo 2',sans-serif; font-size:14px; transition:border-color 0.2s; outline:none; width:100%; }
  .field-input:focus { border-color:var(--mars); box-shadow:0 0 0 2px rgba(192,68,10,0.2); }

  /* ---- PLAYER CHIPS ---- */
  .players-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
  .player-chip { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:6px 14px; font-size:13px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:6px; user-select:none; }
  .player-chip.selected { background:linear-gradient(135deg,var(--mars),#8b2500); border-color:var(--mars); color:white; }
  .player-chip .dot { width:8px; height:8px; border-radius:50%; background:currentColor; }

  /* ---- EXPANSION CHIPS ---- */
  .expansion-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px; }
  .exp-chip { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:7px 16px; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:7px; user-select:none; }
  .exp-chip:hover { border-color:var(--muted); }
  .exp-chip.exp-prelude.selected  { background:linear-gradient(135deg,#1a6b3a,#0e3d22); border-color:#2ecc71; color:#7fffc4; }
  .exp-chip.exp-venus.selected    { background:linear-gradient(135deg,#4a2080,#28104a); border-color:#8b5cf6; color:#c4b5fd; }
  .exp-chip.exp-turmoil.selected  { background:linear-gradient(135deg,#8b2500,#4a1200); border-color:var(--mars2); color:#ffb894; }
  .exp-chip.exp-colonies.selected { background:linear-gradient(135deg,#1a4a6b,#0a2538); border-color:#3b82f6; color:#93c5fd; }

  /* ---- TAGS ---- */
  .tag { font-size:10px; font-weight:700; padding:2px 7px; border-radius:var(--radius-sm); letter-spacing:0.5px; text-transform:uppercase; }
  .tag-prelude  { background:rgba(46,204,113,0.15);  color:#2ecc71;       border:1px solid rgba(46,204,113,0.3);  }
  .tag-venus    { background:rgba(139,92,246,0.15);  color:#8b5cf6;       border:1px solid rgba(139,92,246,0.3);  }
  .tag-turmoil  { background:rgba(232,93,26,0.15);   color:var(--mars2);  border:1px solid rgba(232,93,26,0.3);   }
  .tag-colonies { background:rgba(59,130,246,0.15);  color:#3b82f6;       border:1px solid rgba(59,130,246,0.3);  }
  .tag-map      { background:rgba(59,130,246,0.15);  color:#3b82f6;       border:1px solid rgba(59,130,246,0.3);  }
  .tag-gen      { background:rgba(245,166,35,0.12);  color:var(--gold);   border:1px solid rgba(245,166,35,0.3);  }

  /* ---- MAP SELECTOR ---- */
  .preset-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:8px; }
  .preset-btn  { padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--muted); font-family:'Exo 2',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:8px; user-select:none; }
  .preset-btn:hover { border-color:var(--muted); color:var(--text); }
  .preset-btn.selected { background:linear-gradient(135deg,#2a1a6b,#160a3d); border-color:#8b5cf6; color:#c4b5fd; }

  /* ---- AVATAR ---- */
  .avatar { border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:white; flex-shrink:0; }
  .avatar-sm { width:28px; height:28px; font-size:12px; }
  .avatar-md { width:34px; height:34px; font-size:15px; }
  .avatar-lg { width:56px; height:56px; font-size:24px; }

  /* ---- RANKING ---- */
  .ranking-list { display:flex; flex-direction:column; gap:10px; }
  .rank-item { display:flex; align-items:center; gap:14px; background:var(--surface2); border:1px solid var(--border); border-left-width:3px; border-radius:var(--radius-md); padding:13px 16px; transition:transform 0.2s; }
  .rank-item:hover { transform:translateX(4px); }
  .rank-num  { font-family:'Orbitron',monospace; font-size:18px; font-weight:900; width:30px; text-align:center; }
  .rank-name { font-size:15px; font-weight:600; flex:1; }
  .rank-stats { display:flex; gap:12px; font-size:12px; color:var(--muted); flex-wrap:wrap; }
  .rank-score { font-family:'Orbitron',monospace; font-size:20px; font-weight:700; color:var(--mars2); min-width:50px; text-align:right; }
  .rank-1 .rank-num { color:var(--gold); }
  .rank-2 .rank-num { color:#b0b8c8; }
  .rank-3 .rank-num { color:#cd7f32; }

  /* ---- GAMES LIST ---- */
  .games-list { display:flex; flex-direction:column; gap:10px; }
  .game-card   { background:var(--surface2); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .game-header { display:flex; align-items:center; justify-content:space-between; padding:13px 16px; cursor:pointer; user-select:none; transition:background 0.2s; }
  .game-header:hover { background:rgba(255,255,255,0.03); }
  .game-header-left  { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .game-num    { font-family:'Orbitron',monospace; font-size:11px; color:var(--muted); letter-spacing:1px; }
  .game-date   { font-size:12px; color:var(--muted); }
  .game-winner { color:var(--gold); font-size:13px; }
  .game-expand { color:var(--muted); font-size:16px; transition:transform 0.2s; flex-shrink:0; }
  .game-card.open .game-expand { transform:rotate(180deg); }
  .game-details { display:none; padding:0 16px 16px; overflow-x:auto; }
  .game-card.open .game-details { display:block; }
  .game-actions { display:flex; gap:8px; margin-top:10px; }
  .score-table { width:100%; border-collapse:collapse; font-size:12px; min-width:550px; }
  .score-table th { text-align:left; padding:7px 9px; color:var(--muted); font-weight:600; font-size:10px; letter-spacing:0.5px; text-transform:uppercase; border-bottom:1px solid var(--border); }
  .score-table td { padding:9px; border-bottom:1px solid rgba(30,42,69,0.5); }
  .score-table tr:last-child td { border-bottom:none; }
  .score-table tr.winner td { background:rgba(245,166,35,0.07); }
  .score-table tr.winner td:first-child { color:var(--gold); font-weight:600; }
  .total-cell { font-family:'Orbitron',monospace; font-weight:700; color:var(--mars2); }

  /* ---- SEASON ---- */
  .season-selector { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; }
  .season-btn { padding:9px 16px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--muted); font-family:'Exo 2',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:7px; }
  .season-btn:hover { border-color:var(--muted); color:var(--text); }
  .season-btn.active-spring { background:linear-gradient(135deg,#1a5c2a,#0d3316); border-color:#2ecc71; color:#7fffc4; box-shadow:0 2px 10px rgba(46,204,113,0.2); }
  .season-btn.active-autumn { background:linear-gradient(135deg,#6b3010,#3d1a08); border-color:#e67e22; color:#ffd59e; box-shadow:0 2px 10px rgba(230,126,34,0.2); }
  .season-header { display:flex; align-items:center; gap:14px; margin-bottom:18px; padding-bottom:14px; border-bottom:1px solid var(--border); }
  .season-icon { font-size:32px; line-height:1; }
  .season-title { font-family:'Orbitron',monospace; font-size:18px; font-weight:700; }
  .season-title.spring { color:#2ecc71; }
  .season-title.autumn { color:#e67e22; }
  .season-sub { font-size:12px; color:var(--muted); margin-top:2px; }
  .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; margin-bottom:20px; }
  .stat-box { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-md); padding:13px; text-align:center; }
  .stat-val { font-family:'Orbitron',monospace; font-size:20px; font-weight:700; color:var(--mars2); }
  .stat-lbl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:4px; }

  /* ---- PLAYER PROFILE ---- */
  .player-selector { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:24px; }
  .player-btn { display:flex; align-items:center; gap:8px; padding:8px 16px; background:var(--surface2); border:1px solid var(--border); border-radius:20px; font-family:'Exo 2',sans-serif; font-size:13px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.2s; }
  .player-btn:hover { border-color:var(--muted); color:var(--text); }
  .player-btn.active { color:white; border-color:transparent; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
  .profile-header { display:flex; align-items:center; gap:18px; margin-bottom:22px; padding-bottom:18px; border-bottom:1px solid var(--border); }
  .profile-name { font-family:'Orbitron',monospace; font-size:20px; font-weight:700; }
  .profile-sub  { font-size:13px; color:var(--muted); margin-top:3px; }
  .profile-stats { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:12px; margin-bottom:22px; }
  .profile-stat { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px; text-align:center; }
  .profile-val  { font-family:'Orbitron',monospace; font-size:22px; font-weight:700; color:var(--mars2); }
  .profile-val.gold   { color:var(--gold); }
  .profile-val.silver { color:#b0b8c8; }
  .profile-val.bronze { color:#cd7f32; }
  .profile-val.green  { color:var(--green); }
  .profile-val.muted  { color:var(--muted); }
  .profile-lbl  { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:4px; }
  .cat-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
  .cat-name { font-size:13px; width:130px; flex-shrink:0; }
  .bar-track { flex:1; height:8px; background:var(--bg); border-radius:4px; overflow:hidden; }
  .bar-fill  { height:100%; border-radius:4px; transition:width 0.6s cubic-bezier(.22,1,.36,1); }
  .cat-val  { font-size:12px; font-family:'Orbitron',monospace; color:var(--mars2); width:38px; text-align:right; flex-shrink:0; }
  .recent-row { display:flex; align-items:center; gap:12px; padding:9px 0; border-bottom:1px solid rgba(30,42,69,0.5); font-size:13px; }
  .recent-row:last-child { border-bottom:none; }

  /* ---- STATS PAGE ---- */
  .stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(480px,1fr)); gap:14px; }
  .stats-card { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-md); padding:15px; }
  .stats-card-title { font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--muted); font-weight:600; margin-bottom:11px; display:flex; align-items:center; gap:6px; }
  .col-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
  .bar-row { display:flex; flex-direction:column; gap:4px; margin-bottom:7px; }
  .bar-label { display:flex; justify-content:space-between; font-size:12px; }
  .bar-track-sm { height:7px; background:var(--bg); border-radius:4px; overflow:hidden; }

  /* ---- SCORE ENTRY ---- */
  .score-block { margin-bottom:18px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-md); padding:15px; }

  /* ---- EMPTY STATE ---- */
  .empty { text-align:center; padding:50px 20px; color:var(--muted); }
  .empty-icon { font-size:44px; margin-bottom:10px; opacity:0.5; }
  .empty-text { font-size:14px; }

  /* ---- LOADING ---- */
  .loading { display:flex; align-items:center; justify-content:center; gap:10px; padding:60px; color:var(--muted); font-size:14px; }
  .spinner { width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--mars2); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* ---- MODALS ---- */
  .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:200; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; padding:20px; }
  .overlay.show { opacity:1; pointer-events:all; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-xl); padding:26px; width:100%; max-width:700px; max-height:90vh; overflow-y:auto; transform:translateY(20px); transition:transform 0.2s; }
  .overlay.show .modal { transform:translateY(0); }
  .modal-title   { font-family:'Orbitron',monospace; font-size:14px; letter-spacing:2px; color:var(--mars2); text-transform:uppercase; margin-bottom:20px; }
  .modal-actions { display:flex; gap:10px; margin-top:20px; justify-content:flex-end; }
  .login-box { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-xl); padding:32px; width:100%; max-width:380px; transform:translateY(20px); transition:transform 0.2s; }
  .overlay.show .login-box { transform:translateY(0); }
  .login-error { color:#e74c3c; font-size:13px; margin-top:8px; min-height:18px; }

  /* ---- TOAST ---- */
  .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-md); padding:12px 24px; font-size:14px; z-index:400; opacity:0; transition:all 0.3s; pointer-events:none; white-space:nowrap; }
  .toast.show    { opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.success { border-color:#2ecc71; color:#2ecc71; }
  .toast.error   { border-color:#e74c3c; color:#e74c3c; }

  /* ---- UTILITIES ---- */
  .flex     { display:flex; }
  .gap-2    { gap:8px; }
  .row-between { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; }

  @media(max-width:600px) {
    .rank-stats { display:none; }
    .tabs { gap:2px; }
    .tab  { font-size:10px; padding:7px 8px; min-width:70px; }
    .stats-grid { grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="planet"></div>
    <div class="logo">Terraforming Mars</div>
    <div class="logo-sub">Tulosseuranta</div>
  </header>

  <div class="auth-bar">
    <span class="auth-status" id="auth-status">Julkinen n√§kym√§</span>
    <button class="btn-auth" id="auth-btn" onclick="toggleLoginModal()">üîê Kirjaudu</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('ranking')">üèÜ Ranking</button>
    <button class="tab" onclick="showTab('games')">üé≤ Pelit</button>
    <button class="tab" onclick="showTab('season')">üåç Season</button>
    <button class="tab" onclick="showTab('players')">üë§ Pelaajat</button>
    <button class="tab" onclick="showTab('categories')">üìä Statistiikkaa</button>
    <button class="tab admin-only" id="tab-add" onclick="showTab('add')">‚ûï Lis√§√§ peli</button>
  </div>

  <!-- RANKING -->
  <div id="panel-ranking" class="panel active">
    <div class="card">
      <div class="row-between" style="margin-bottom:14px">
        <div class="card-title" style="margin-bottom:0">Pelaajien ranking</div>
        <div class="btn-row" id="ranking-filter">
          <button class="filter-btn active" onclick="setFilter('ranking',0)">Kaikki</button>
          <button class="filter-btn" onclick="setFilter('ranking',3)">3 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('ranking',4)">4 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('ranking',5)">5 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('ranking',6)">6 pelaajaa</button>
        </div>
      </div>
      <div class="btn-row" id="ranking-sort" style="margin-bottom:18px">
        <button class="sort-btn" onclick="setSort('ranking','avg')">‚≠ê Keskiarvo</button>
        <button class="sort-btn" onclick="setSort('ranking','best')">üèÜ Paras tulos</button>
        <button class="sort-btn active" onclick="setSort('ranking','wins')">ü•á Voitot</button>
        <button class="sort-btn" onclick="setSort('ranking','second')">ü•à Toinen sija</button>
        <button class="sort-btn" onclick="setSort('ranking','third')">ü•â Kolmas sija</button>
        <button class="sort-btn" onclick="setSort('ranking','games')">üé≤ Pelej√§</button>
        <button class="sort-btn" onclick="setSort('ranking','winpct')">üìà Voitto%</button>
      </div>
      <div id="ranking-list" class="ranking-list"></div>
    </div>
  </div>

  <!-- GAMES -->
  <div id="panel-games" class="panel">
    <div class="card">
      <div class="row-between" style="margin-bottom:18px">
        <div class="card-title" style="margin-bottom:0">Kaikki pelit</div>
        <div class="btn-row" id="games-filter">
          <button class="filter-btn active" onclick="setFilter('games',0)">Kaikki</button>
          <button class="filter-btn" onclick="setFilter('games',3)">3 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('games',4)">4 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('games',5)">5 pelaajaa</button>
          <button class="filter-btn" onclick="setFilter('games',6)">6 pelaajaa</button>
        </div>
      </div>
      <div id="games-list" class="games-list"></div>
    </div>
  </div>

  <!-- SEASON -->
  <div id="panel-season" class="panel">
    <div id="season-content"></div>
  </div>

  <!-- PLAYERS -->
  <div id="panel-players" class="panel">
    <div id="players-content"></div>
  </div>

  <!-- STATISTIIKKAA -->
  <div id="panel-categories" class="panel">
    <div id="cat-sections"></div>
  </div>

  <!-- ADD GAME (admin only) -->
  <div id="panel-add" class="panel">
    <div class="card">
      <div class="card-title">Lis√§√§ uusi peli</div>
      <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr">
        <div class="field-group">
          <div class="field-label">P√§iv√§m√§√§r√§</div>
          <input class="field-input" type="date" id="inp-date">
        </div>
        <div class="field-group">
          <div class="field-label">Pelinumero</div>
          <div class="field-input" id="inp-gamenum-display" style="opacity:0.6;cursor:default;background:var(--surface2)">‚Äî</div>
        </div>
        <div class="field-group">
          <div class="field-label">üåç Sukupolvi (lopetus)</div>
          <input class="field-input" type="number" id="inp-generation" placeholder="esim. 12" min="1" max="30">
        </div>
      </div>
      <div class="card-title" style="margin-top:18px">K√§yt√∂ss√§ olevat lis√§osat</div>
      <div class="expansion-row">
        <div class="exp-chip exp-prelude"  id="exp-Prelude"   onclick="toggleExpansion('Prelude')">üå± Prelude</div>
        <div class="exp-chip exp-venus"    id="exp-Venus"     onclick="toggleExpansion('Venus')">‚òÅÔ∏è Venus Next</div>
        <div class="exp-chip exp-turmoil"  id="exp-Turmoil"   onclick="toggleExpansion('Turmoil')">üî• Turmoil</div>
        <div class="exp-chip exp-colonies" id="exp-Colonies"  onclick="toggleExpansion('Colonies')">üõ∏ Colonies</div>
      </div>
      <div class="card-title" style="margin-top:4px">Kartta</div>
      <div class="preset-grid" id="map-grid"></div>
      <div id="random-presets" style="display:none"></div>
      <div class="card-title" style="margin-top:18px">
        Valitse pelaajat
        <span style="font-size:11px;color:var(--muted);font-family:'Exo 2',sans-serif;font-weight:400;letter-spacing:0;margin-left:6px">‚Äî j√§rjestys = aloitusj√§rjestys</span>
      </div>
      <div id="player-select" class="players-row"></div>
      <div class="flex gap-2" style="margin-bottom:16px">
        <input class="field-input" id="new-player-name" placeholder="Lis√§√§ uusi pelaaja..." style="max-width:220px">
        <button class="btn btn-secondary" onclick="addPlayer()">Lis√§√§</button>
      </div>
      <div id="score-sections" style="margin-top:20px"></div>
      <div class="flex gap-2" style="margin-top:20px">
        <button class="btn" id="save-game-btn" onclick="saveGame()">Tallenna peli</button>
        <button class="btn btn-secondary" onclick="clearForm()">Tyhjenn√§</button>
      </div>
    </div>
  </div>

</div>

<!-- Edit modal -->
<div class="overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">Muokkaa pelitulosta</div>
    <div id="edit-modal-content"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Peruuta</button>
      <button class="btn" onclick="saveEdit()">Tallenna</button>
    </div>
  </div>
</div>

<!-- Login modal -->
<div class="overlay" id="login-overlay">
  <div class="login-box">
    <div class="modal-title">üîê Admin kirjautuminen</div>
    <div class="field-group" style="margin-bottom:12px">
      <div class="field-label">S√§hk√∂posti</div>
      <input class="field-input" type="email" id="login-email" placeholder="admin@example.com">
    </div>
    <div class="field-group" style="margin-bottom:4px">
      <div class="field-label">Salasana</div>
      <input class="field-input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-error" id="login-error"></div>
    <div class="flex gap-2" style="margin-top:16px">
      <button class="btn" onclick="doLogin()">Kirjaudu</button>
      <button class="btn btn-secondary" onclick="closeLoginModal()">Peruuta</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const SUPABASE_URL = 'https://ixghjaselkwipbjgmrps.supabase.co';
const SUPABASE_KEY = 'sb_publishable_RJGC8unRN6fRKuZ2yi4ujA_GaPWAuCB';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================================
// CONSTANTS
// ============================================================
const SCORE_FIELDS = [
  { key:'tr',         label:'TR',             icon:'üå°Ô∏è' },
  { key:'awards',     label:'Awards',         icon:'üèÖ' },
  { key:'milestones', label:'Milestones',     icon:'üéØ' },
  { key:'cities',     label:'Cities',         icon:'üèôÔ∏è' },
  { key:'greeneries', label:'Greeneries',     icon:'üåø' },
  { key:'cards',      label:'Cards & Events', icon:'üÉè' },
  { key:'delegates',  label:'Delegates',      icon:'üó≥Ô∏è' },
  { key:'pathfinder', label:'Pathfinder',     icon:'üõ∏' },
  { key:'venus',      label:'Venus Phase',    icon:'‚òÅÔ∏è' },
  { key:'total',      label:'Total',          icon:'‚≠ê' },
];

const PLAYER_COLORS = ['#e85d1a','#3b82f6','#2ecc71','#8b5cf6','#f5a623','#e74c3c','#1abc9c','#e91e63'];

const EXPANSIONS = [
  { key:'Prelude',  label:'Prelude',     icon:'üå±', cls:'exp-prelude'  },
  { key:'Venus',    label:'Venus Next',  icon:'‚òÅÔ∏è', cls:'exp-venus'    },
  { key:'Turmoil',  label:'Turmoil',    icon:'üî•', cls:'exp-turmoil'  },
  { key:'Colonies', label:'Colonies',   icon:'üõ∏', cls:'exp-colonies' },
];

const MAPS = [
  { key:'Standard', label:'Peruskartta',  icon:'üó∫Ô∏è' },
  { key:'Hellas',   label:'Hellas',       icon:'üåã' },
  { key:'Elysium',  label:'Elysium',      icon:'üèîÔ∏è' },
  { key:'Utopia',   label:'Utopia',       icon:'üåø' },
  { key:'Cimmeria', label:'Cimmeria',     icon:'‚ùÑÔ∏è' },
  { key:'Amazonis', label:'Amazonis',     icon:'üåä' },
  { key:'Vastitas', label:'Vastitas',     icon:'üèúÔ∏è' },
  { key:'Random',   label:'Random-kartta',icon:'üé≤' },
];

const RANDOM_PRESETS = [
  { key:'Default',          label:'Default',           icon:'üåç' },
  { key:'FirstExplorers',   label:'First Explorers',   icon:'üî≠' },
  { key:'MartianDesert',    label:'Martian Desert',    icon:'üèúÔ∏è' },
  { key:'RichDeposits',     label:'Rich Deposits',     icon:'üíé' },
  { key:'FastTerraformers', label:'Fast Terraformers', icon:'‚ö°' },
  { key:'JungleWorld',      label:'Jungle World',      icon:'üå¥' },
];

const ALL_MAPS = [...MAPS, ...RANDOM_PRESETS];

const SORT_KEYS = ['avg','best','wins','second','third','games','winpct'];

// ============================================================
// STATE
// ============================================================
const state = { players:[], games:[], isAdmin:false };

const ui = {
  rankingFilter: 0,
  rankingSort:   'wins',
  gamesFilter:   0,
  currentSeason: null,
  seasonSort:    'wins',
  selectedPlayer:null,
  statsFilter:   0,
};

// Season ranking cache ‚Äî populated by renderSeason(), consumed by renderSeasonRanking()
let seasonRanked = [];

// Form state
const form = {
  players:    [],
  expansions: [],
  map:        null,
  mapPreset:  null,
};

// ============================================================
// HELPERS
// ============================================================
function getPlayerColor(name) {
  const idx = state.players.findIndex(p => (p.name || p) === name);
  return PLAYER_COLORS[Math.max(idx, 0) % PLAYER_COLORS.length];
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

function median(arr) {
  if (!arr.length) return 0;
  const s = [...arr].sort((a, b) => a - b);
  const m = Math.floor(s.length / 2);
  return s.length % 2 !== 0 ? s[m] : (s[m - 1] + s[m]) / 2;
}

// Build player stats from a list of games
function buildPlayerStats(games) {
  const stats = {};
  games.forEach(g => {
    const scores = g.scores || [];
    const sorted = [...scores].sort((a, b) => (b.total || 0) - (a.total || 0));
    scores.forEach(s => {
      if (!stats[s.player]) stats[s.player] = { wins:0, second:0, third:0, games:0, totalPts:0, best:0 };
      const st = stats[s.player];
      st.games++;
      st.totalPts += s.total || 0;
      if ((s.total || 0) > st.best) st.best = s.total;
      const pos = sorted.findIndex(x => x.player === s.player);
      if (pos === 0) st.wins++;
      else if (pos === 1) st.second++;
      else if (pos === 2) st.third++;
    });
  });
  return Object.entries(stats).map(([name, s]) => ({
    name,
    avg:    Math.round(s.totalPts / s.games),
    winpct: Math.round(s.wins / s.games * 100),
    ...s,
  }));
}

const SORT_FNS = {
  avg:    (a, b) => b.avg    - a.avg    || b.wins - a.wins,
  best:   (a, b) => b.best   - a.best   || b.avg  - a.avg,
  wins:   (a, b) => b.wins   - a.wins   || b.avg  - a.avg,
  second: (a, b) => b.second - a.second || b.avg  - a.avg,
  third:  (a, b) => b.third  - a.third  || b.avg  - a.avg,
  games:  (a, b) => b.games  - a.games  || b.avg  - a.avg,
  winpct: (a, b) => b.winpct - a.winpct || b.avg  - a.avg,
};

const HIGHLIGHT_FN = {
  avg:    p => ({ val: p.avg,           lbl: 'ka' }),
  best:   p => ({ val: p.best,          lbl: 'paras' }),
  wins:   p => ({ val: p.wins,          lbl: 'voittoa' }),
  second: p => ({ val: p.second,        lbl: '2. sijaa' }),
  third:  p => ({ val: p.third,         lbl: '3. sijaa' }),
  games:  p => ({ val: p.games,         lbl: 'peli√§' }),
  winpct: p => ({ val: p.winpct + '%',  lbl: 'voitto%' }),
};

function buildAvatar(name, size = 'md') {
  const color = getPlayerColor(name);
  return `<div class="avatar avatar-${size}" style="background:${color}">${name[0].toUpperCase()}</div>`;
}

function buildRankingRow(p, i, sortKey) {
  const color = getPlayerColor(p.name);
  const h = HIGHLIGHT_FN[sortKey](p);
  const hl = k => sortKey === k ? 'color:var(--text)' : (k === 'wins' ? 'color:#b0b8c8' : '');
  return `
    <div class="rank-item rank-${i + 1}" style="border-left-color:${color}">
      <div class="rank-num">${i + 1}</div>
      ${buildAvatar(p.name, 'md')}
      <div class="rank-name">${p.name}</div>
      <div class="rank-stats">
        <span style="${hl('games')}">${p.games} peli√§</span>
        <span style="${sortKey === 'wins' ? 'color:var(--gold)' : 'color:#b0b8c8'}">ü•á ${p.wins}</span>
        <span style="${hl('second')}">ü•à ${p.second}</span>
        <span style="${hl('third')}">ü•â ${p.third}</span>
        <span style="${hl('winpct')}">${p.winpct}%</span>
        <span style="${hl('best')}">‚Üë${p.best}</span>
        <span style="${hl('avg')}">‚åÄ${p.avg}</span>
      </div>
      <div class="rank-score" title="${h.lbl}">${h.val}</div>
    </div>`;
}

function buildFilteredGames(filter) {
  return filter === 0 ? state.games : state.games.filter(g => (g.scores || []).length === filter);
}

function buildFilterBtns(containerId, currentVal) {
  document.querySelectorAll(`#${containerId} .filter-btn`).forEach((b, i) =>
    b.classList.toggle('active', i === [0, 3, 4, 5, 6].indexOf(currentVal)));
}

function buildSortBtns(containerId, currentVal) {
  document.querySelectorAll(`#${containerId} .sort-btn`).forEach((b, i) =>
    b.classList.toggle('active', i === SORT_KEYS.indexOf(currentVal)));
}

// ============================================================
// AUTH
// ============================================================
async function initAuth() {
  const { data: { session } } = await sb.auth.getSession();
  applyAuthState(session?.user ?? null);
  sb.auth.onAuthStateChange((_, session) => applyAuthState(session?.user ?? null));
}

function applyAuthState(user) {
  state.isAdmin = !!user;
  document.getElementById('auth-status').textContent = user ? `üë§ ${user.email}` : 'Julkinen n√§kym√§';
  document.getElementById('auth-status').className = 'auth-status' + (user ? ' logged-in' : '');
  document.getElementById('auth-btn').textContent = user ? 'üö™ Kirjaudu ulos' : 'üîê Kirjaudu';
  document.getElementById('auth-btn').className = 'btn-auth' + (user ? ' logout' : '');
  document.getElementById('auth-btn').onclick = user ? doLogout : toggleLoginModal;
  document.getElementById('tab-add').classList.toggle('visible', state.isAdmin);
  const active = document.querySelector('.panel.active');
  if (active?.id === 'panel-games')   renderGames();
  if (active?.id === 'panel-ranking') renderRanking();
}

function toggleLoginModal() { document.getElementById('login-overlay').classList.add('show'); setTimeout(() => document.getElementById('login-email').focus(), 100); }
function closeLoginModal()  { document.getElementById('login-overlay').classList.remove('show'); document.getElementById('login-error').textContent = ''; }

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  document.getElementById('login-error').textContent = '';
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { document.getElementById('login-error').textContent = 'V√§√§r√§ s√§hk√∂posti tai salasana.'; return; }
  closeLoginModal();
  showToast('Kirjauduttu sis√§√§n ‚úì');
}

async function doLogout() {
  await sb.auth.signOut();
  showToast('Kirjauduttu ulos');
}

// ============================================================
// DATA
// ============================================================
async function loadData() {
  const { data: players } = await sb.from('players').select('*').order('id');
  const { data: games }   = await sb.from('games').select('*, scores(*)').order('game_num');
  state.players = players || [];
  state.games   = (games || []).map(g => ({
    ...g,
    expansions: g.expansions || [],
    scores: (g.scores || [])
      .sort((a, b) => a.turn_order - b.turn_order)
      .map(s => ({
        player: s.player_name, turn_order: s.turn_order,
        tr: s.tr, awards: s.awards, milestones: s.milestones,
        cities: s.cities, greeneries: s.greeneries, cards: s.cards,
        delegates: s.delegates, pathfinder: s.pathfinder, venus: s.venus,
        total: s.total,
      })),
  }));
}

async function refreshAndRender() {
  await loadData();
  const name = document.querySelector('.panel.active')?.id?.replace('panel-', '') || 'ranking';
  showTab(name);
}

// ============================================================
// TABS
// ============================================================
const TAB_NAMES = ['ranking', 'games', 'season', 'players', 'categories', 'add'];

function showTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', TAB_NAMES[i] === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  const renderers = { ranking: renderRanking, games: renderGames, season: renderSeason, players: renderPlayers, categories: renderCategories, add: renderAddForm };
  renderers[name]?.();
}

// ============================================================
// FILTERS & SORTS
// ============================================================
function setFilter(page, n) {
  if (page === 'ranking') { ui.rankingFilter = n; buildFilterBtns('ranking-filter', n); renderRanking(); }
  if (page === 'games')   { ui.gamesFilter   = n; buildFilterBtns('games-filter',   n); renderGames();   }
  if (page === 'stats')   { ui.statsFilter   = n; buildFilterBtns('stats-filter',   n); renderCategoriesContent(); }
}

function setSort(page, key) {
  if (page === 'ranking') {
    ui.rankingSort = key;
    buildSortBtns('ranking-sort', key);
    renderRanking();
  }
  if (page === 'season') {
    ui.seasonSort = key;
    buildSortBtns('season-sort', key);
    renderSeasonRanking();
  }
}

function selectSeason(key) { ui.currentSeason = key; renderSeason(); }
function selectPlayer(name) { ui.selectedPlayer = name; renderPlayers(); }

// ============================================================
// RANKING
// ============================================================
function renderRanking() {
  const el = document.getElementById('ranking-list');
  const games = buildFilteredGames(ui.rankingFilter);
  if (!games.length) {
    el.innerHTML = state.games.length
      ? `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">Ei ${ui.rankingFilter} pelaajan pelej√§.</div></div>`
      : '<div class="empty"><div class="empty-icon">ü™ê</div><div class="empty-text">Ei viel√§ pelej√§.</div></div>';
    return;
  }
  const ranked = buildPlayerStats(games).sort(SORT_FNS[ui.rankingSort]);
  el.innerHTML  = ranked.map((p, i) => buildRankingRow(p, i, ui.rankingSort)).join('');
}

// ============================================================
// GAMES
// ============================================================
function buildGameCard(g, idPrefix = 'gc') {
  const scores  = g.scores || [];
  const byScore = [...scores].sort((a, b) => (b.total || 0) - (a.total || 0));
  const winner  = byScore[0]?.player || '';
  const starter = scores[0]?.player || '';

  const expTags = (g.expansions || []).map(e => {
    const exp = EXPANSIONS.find(x => x.key === e);
    return exp ? `<span class="tag tag-${e.toLowerCase()}">${exp.icon} ${exp.label}</span>` : '';
  }).join('');

  const mapMain = MAPS.find(m => m.key === g.map_type);
  const mapSub  = RANDOM_PRESETS.find(p => p.key === g.map_preset);
  const mapTag  = mapMain ? `<span class="tag tag-map">${mapMain.icon} ${mapMain.label}${mapSub ? ' ¬∑ ' + mapSub.label : ''}</span>` : '';
  const genTag  = g.generation ? `<span class="tag tag-gen">üåç Gen ${g.generation}</span>` : '';

  const adminBtns = state.isAdmin ? `
    <div class="game-actions">
      <button class="btn btn-secondary" style="font-size:11px;padding:7px 12px" data-action="edit"   data-id="${g.id}">‚úèÔ∏è Muokkaa</button>
      <button class="btn btn-danger"    style="font-size:11px;padding:7px 12px" data-action="delete" data-id="${g.id}">üóëÔ∏è Poista</button>
    </div>` : '';

  return `
    <div class="game-card" id="${idPrefix}-${g.id}">
      <div class="game-header" onclick="document.getElementById('${idPrefix}-${g.id}').classList.toggle('open')">
        <div class="game-header-left">
          <span class="game-num">PELI #${g.game_num || g.id}</span>
          <span class="game-date">${g.date || ''}</span>
          <span style="font-weight:600;font-size:14px">${scores.map((s, i) => i === 0 ? `<span style="color:var(--mars2)">‚öë ${s.player}</span>` : s.player).join(', ')}</span>
          ${genTag}${expTags}${mapTag}
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <span class="game-winner">üëë ${winner}</span>
          <span class="game-expand">‚ñº</span>
        </div>
      </div>
      <div class="game-details">
        <table class="score-table">
          <thead><tr><th>Pelaaja</th>${SCORE_FIELDS.map(f => `<th>${f.label}</th>`).join('')}</tr></thead>
          <tbody>
            ${byScore.map((s, i) => `
              <tr class="${i === 0 ? 'winner' : ''}">
                <td>${i === 0 ? 'üëë ' : ''}${s.player}${s.player === starter ? ' <span style="font-size:10px;color:var(--mars2)">‚öë</span>' : ''}</td>
                ${SCORE_FIELDS.map(f => `<td class="${f.key === 'total' ? 'total-cell' : ''}">${s[f.key] ?? '-'}</td>`).join('')}
              </tr>`).join('')}
          </tbody>
        </table>
        ${adminBtns}
      </div>
    </div>`;
}

function renderGames() {
  const el = document.getElementById('games-list');
  if (!state.games.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üé≤</div><div class="empty-text">Ei viel√§ pelej√§.</div></div>'; return; }
  const filtered = [...state.games].reverse().filter(g => ui.gamesFilter === 0 || (g.scores || []).length === ui.gamesFilter);
  if (!filtered.length) { el.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">Ei ${ui.gamesFilter} pelaajan pelej√§.</div></div>`; return; }
  el.innerHTML = filtered.map(g => buildGameCard(g)).join('');
  el.onclick = e => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    e.stopPropagation();
    const id = parseInt(btn.dataset.id);
    if (btn.dataset.action === 'delete') deleteGame(id);
    if (btn.dataset.action === 'edit')   editGame(id);
  };
}

async function deleteGame(id) {
  const g = state.games.find(x => x.id === id);
  if (!g || !window.confirm(`Poistetaanko Peli #${g.game_num}?`)) return;
  const { error } = await sb.from('games').delete().eq('id', id);
  if (error) { showToast('Virhe poistamisessa', 'error'); return; }
  showToast('Peli poistettu');
  await refreshAndRender();
}

// ============================================================
// SEASON
// ============================================================
function getSeasonFromDate(dateStr) {
  if (!dateStr) return null;
  const d    = new Date(dateStr);
  const year = d.getFullYear() % 100;
  const type = d.getMonth() <= 5 ? 'spring' : 'autumn';
  return { type, year, key: `${type}-${year}`, label: (type === 'spring' ? 'üå± Kev√§t' : 'üçÇ Syksy') + ` '${String(year).padStart(2, '0')}` };
}

function getAllSeasons() {
  const seen = new Map();
  state.games.forEach(g => { const s = getSeasonFromDate(g.date); if (s && !seen.has(s.key)) seen.set(s.key, s); });
  return [...seen.values()].sort((a, b) => a.year !== b.year ? a.year - b.year : a.type === 'spring' ? -1 : 1);
}

function renderSeasonRanking() {
  const el = document.getElementById('season-ranking-list');
  if (!el || !seasonRanked.length) return;
  const sorted = [...seasonRanked].sort(SORT_FNS[ui.seasonSort]);
  el.innerHTML = sorted.map((p, i) => buildRankingRow(p, i, ui.seasonSort)).join('');
}

function renderSeason() {
  const el      = document.getElementById('season-content');
  const seasons = getAllSeasons();
  if (!seasons.length) { el.innerHTML = '<div class="card"><div class="empty"><div class="empty-icon">üìÖ</div><div class="empty-text">Ei pelej√§ joilla on p√§iv√§m√§√§r√§.</div></div></div>'; return; }

  if (!ui.currentSeason || !seasons.find(s => s.key === ui.currentSeason))
    ui.currentSeason = seasons[seasons.length - 1].key;

  const season      = seasons.find(s => s.key === ui.currentSeason);
  const seasonGames = state.games.filter(g => { const s = getSeasonFromDate(g.date); return s && s.key === ui.currentSeason; });
  const ranked      = buildPlayerStats(seasonGames).sort(SORT_FNS.wins);
  seasonRanked  = ranked;

  const champion  = ranked[0];
  const highScore = ranked.reduce((m, p) => p.best > m ? p.best : m, 0);
  const avgScore  = ranked.length ? Math.round(ranked.reduce((a, p) => a + p.avg, 0) / ranked.length) : 0;

  const seasonLabel = `${season.type === 'spring' ? 'Kev√§t' : 'Syksy'} '${String(season.year).padStart(2, '0')}`;

  el.innerHTML = `
    <div class="season-selector">
      ${seasons.map(s => `
        <button class="season-btn ${s.key === ui.currentSeason ? (s.type === 'spring' ? 'active-spring' : 'active-autumn') : ''}"
          onclick="selectSeason('${s.key}')">
          ${s.type === 'spring' ? 'üå± Kev√§t' : 'üçÇ Syksy'} '${String(s.year).padStart(2, '0')}
        </button>`).join('')}
    </div>
    <div class="card" style="margin-bottom:18px">
      <div class="season-header">
        <div class="season-icon">${season.type === 'spring' ? 'üå±' : 'üçÇ'}</div>
        <div>
          <div class="season-title ${season.type}">${seasonLabel}</div>
          <div class="season-sub">${season.type === 'spring' ? '1.1‚Äì30.6' : '1.7‚Äì31.12'} ¬∑ ${seasonGames.length} peli√§</div>
        </div>
        ${champion ? `<div style="margin-left:auto;text-align:right">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Season-mestari</div>
          <div style="font-size:17px;font-weight:700;color:var(--gold)">üëë ${champion.name}</div>
          <div style="font-size:12px;color:var(--muted)">${champion.avg} ka ¬∑ ${champion.wins} voittoa</div>
        </div>` : ''}
      </div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-val">${seasonGames.length}</div><div class="stat-lbl">Pelej√§</div></div>
        <div class="stat-box"><div class="stat-val">${ranked.length}</div><div class="stat-lbl">Pelaajaa</div></div>
        <div class="stat-box"><div class="stat-val">${highScore}</div><div class="stat-lbl">Huipputulos</div></div>
        <div class="stat-box"><div class="stat-val">${avgScore}</div><div class="stat-lbl">Ka pisteet</div></div>
        ${champion ? `<div class="stat-box"><div class="stat-val" style="font-size:14px">${champion.name}</div><div class="stat-lbl">Eniten voittoja (${champion.wins})</div></div>` : ''}
      </div>
    </div>
    <div class="card" style="margin-bottom:18px">
      <div class="card-title" style="margin-bottom:14px">Season ranking</div>
      <div class="btn-row" id="season-sort" style="margin-bottom:16px">
        ${['avg','best','wins','second','third','games','winpct'].map((k,i) => {
          const labels = ['‚≠ê Keskiarvo','üèÜ Paras tulos','ü•á Voitot','ü•à Toinen sija','ü•â Kolmas sija','üé≤ Pelej√§','üìà Voitto%'];
          return `<button class="sort-btn ${ui.seasonSort === k ? 'active' : ''}" onclick="setSort('season','${k}')">${labels[i]}</button>`;
        }).join('')}
      </div>
      <div class="ranking-list" id="season-ranking-list"></div>
    </div>
    <div class="card">
      <div class="card-title">${seasonLabel} pelit</div>
      <div class="games-list">${[...seasonGames].reverse().map(g => buildGameCard(g, 'sg')).join('')}</div>
    </div>`;

  renderSeasonRanking();
}

// ============================================================
// PLAYERS
// ============================================================
function renderPlayers() {
  const el = document.getElementById('players-content');
  if (!state.players.length) { el.innerHTML = '<div class="card"><div class="empty"><div class="empty-icon">üë§</div><div class="empty-text">Ei pelaajia viel√§.</div></div></div>'; return; }

  if (!ui.selectedPlayer || !state.players.find(p => (p.name || p) === ui.selectedPlayer))
    ui.selectedPlayer = state.players[0].name || state.players[0];

  el.innerHTML = `
    <div class="card" style="margin-bottom:20px">
      <div class="card-title" style="margin-bottom:14px">Valitse pelaaja</div>
      <div class="player-selector">
        ${state.players.map(p => {
          const name  = p.name || p;
          const color = getPlayerColor(name);
          const active = name === ui.selectedPlayer;
          return `<button class="player-btn ${active ? 'active' : ''}" style="${active ? 'background:' + color : ''}" onclick="selectPlayer('${name}')">
            ${buildAvatar(name, 'sm')} ${name}
          </button>`;
        }).join('')}
      </div>
    </div>
    <div id="player-profile"></div>`;

  renderPlayerProfile();
}

function renderPlayerProfile() {
  const el   = document.getElementById('player-profile');
  const name = ui.selectedPlayer;
  if (!el || !name) return;

  const color  = getPlayerColor(name);
  const pgames = state.games.filter(g => (g.scores || []).some(s => s.player === name));
  const scores = pgames.map(g => {
    const s      = g.scores.find(x => x.player === name);
    const sorted = [...g.scores].sort((a, b) => (b.total || 0) - (a.total || 0));
    return { ...s, date: g.date, gameNum: g.game_num, pos: sorted.findIndex(x => x.player === name), playerCount: g.scores.length };
  });

  if (!scores.length) { el.innerHTML = `<div class="card"><div class="empty"><div class="empty-icon">üé≤</div><div class="empty-text">Ei pelej√§ viel√§.</div></div></div>`; return; }

  const n          = scores.length;
  const wins       = scores.filter(s => s.pos === 0).length;
  const seconds    = scores.filter(s => s.pos === 1).length;
  const thirds     = scores.filter(s => s.pos === 2).length;
  const winPct     = Math.round(wins / n * 100);
  const totals     = scores.map(s => s.total || 0);
  const avgTotal   = Math.round(totals.reduce((a, b) => a + b, 0) / n);
  const bestTotal  = Math.max(...totals);
  const worstTotal = Math.min(...totals);

  const positions     = scores.map(s => s.pos + 1);
  const avgPos        = (positions.reduce((a, b) => a + b, 0) / n).toFixed(1);
  const medianPos     = median(positions).toFixed(1);

  const startPos      = scores.map(s => (s.turn_order ?? 0) + 1);
  const avgStart      = (startPos.reduce((a, b) => a + b, 0) / n).toFixed(1);
  const medianStart   = median(startPos).toFixed(1);

  const cats    = SCORE_FIELDS.filter(f => f.key !== 'total');
  const catAvgs = cats.map(f => {
    const vals = scores.map(s => s[f.key] || 0);
    return { ...f, avg: vals.reduce((a, b) => a + b, 0) / vals.length };
  }).filter(c => c.avg > 0); // hide empty categories
  const catMax = Math.max(...catAvgs.map(c => c.avg), 1);

  const recent = [...scores].sort((a, b) => {
    if (!a.date && !b.date) return b.gameNum - a.gameNum;
    if (!a.date) return 1;
    if (!b.date) return -1;
    return new Date(b.date) - new Date(a.date);
  }).slice(0, 8);

  const podium = ['ü•á', 'ü•à', 'ü•â'];

  const statBox = (val, lbl, cls = '') =>
    `<div class="profile-stat"><div class="profile-val ${cls}">${val}</div><div class="profile-lbl">${lbl}</div></div>`;

  el.innerHTML = `
    <div class="card" style="margin-bottom:20px">
      <div class="profile-header">
        ${buildAvatar(name, 'lg')}
        <div>
          <div class="profile-name">${name}</div>
          <div class="profile-sub">${n} peli√§ ¬∑ ${winPct}% voittoprosentti ¬∑ Keskisijoitus ${avgPos}</div>
        </div>
      </div>
      <div class="profile-stats">
        ${statBox(n,           'Pelej√§')}
        ${statBox(wins,        'ü•á Voittoa',       'gold')}
        ${statBox(seconds,     'ü•à Toinen sija',   'silver')}
        ${statBox(thirds,      'ü•â Kolmas sija',   'bronze')}
        ${statBox(avgPos,      'Ka sijoitus')}
        ${statBox(medianPos,   'Mediaani sijoitus')}
        ${statBox(winPct+'%',  'Voitto%')}
        ${statBox(avgTotal,    'Keskiarvo')}
        ${statBox(bestTotal,   'Paras tulos',      'green')}
        ${statBox(worstTotal,  'Heikoin tulos',    'muted')}
        ${statBox(avgStart,    'Ka aloituspaikka')}
        ${statBox(medianStart, 'Mediaani aloitus')}
      </div>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-title">Kategoriakeskiarvot</div>
      ${catAvgs.map(c => `
        <div class="cat-row">
          <div class="cat-name">${c.icon} ${c.label}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${(c.avg / catMax * 100).toFixed(1)}%;background:${color}"></div></div>
          <div class="cat-val">${c.avg.toFixed(1)}</div>
        </div>`).join('')}
    </div>
    <div class="card">
      <div class="card-title">Viimeisimm√§t pelit</div>
      ${recent.map(s => `
        <div class="recent-row">
          <span style="font-family:'Orbitron',monospace;font-size:11px;color:var(--muted);min-width:60px">#${s.gameNum}</span>
          <span style="color:var(--muted);min-width:80px;font-size:12px">${s.date || '‚Äî'}</span>
          <span style="font-size:16px">${podium[s.pos] || `${s.pos + 1}.`}</span>
          <span style="color:var(--muted);font-size:12px">/${s.playerCount} pelaajaa</span>
          <span style="margin-left:auto;font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:var(--mars2)">${s.total}</span>
        </div>`).join('')}
    </div>`;
}

// ============================================================
// STATISTICS
// ============================================================
function fmt(val, decimals = 1) {
  return Number.isInteger(val) ? val : Number(val).toFixed(decimals);
}

function buildStatBar(player, val, maxVal, opts = {}) {
  const color    = getPlayerColor(player);
  const opacity  = opts.opacity  ? `opacity:${opts.opacity}` : '';
  const valStyle = opts.valStyle || '';
  return `
    <div class="bar-row">
      <div class="bar-label"><span>${player}</span><span style="${valStyle}">${fmt(val)}</span></div>
      <div class="bar-track-sm"><div class="bar-fill" style="width:${(val / (maxVal || 1) * 100).toFixed(1)}%;background:${color};${opacity}"></div></div>
    </div>`;
}

function buildStatCol(players, valFn, maxFn, label, opts = {}) {
  const sorted = [...players].sort((a, b) => valFn(b) - valFn(a));
  const max    = maxFn(players);
  return `
    <div>
      <div class="col-label">${label}</div>
      ${sorted.map(p => buildStatBar(p.player, valFn(p), max, opts)).join('')}
    </div>`;
}

function renderCategories() {
  const el = document.getElementById('cat-sections');
  if (!state.games.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìä</div><div class="empty-text">Ei pelej√§</div></div>'; return; }

  el.innerHTML = `
    <div class="card" style="margin-bottom:20px">
      <div class="row-between">
        <div class="card-title" style="margin-bottom:0">Statistiikkaa</div>
        <div class="btn-row" id="stats-filter">
          <button class="filter-btn ${ui.statsFilter === 0 ? 'active' : ''}" onclick="setFilter('stats',0)">Kaikki</button>
          <button class="filter-btn ${ui.statsFilter === 3 ? 'active' : ''}" onclick="setFilter('stats',3)">3 pelaajaa</button>
          <button class="filter-btn ${ui.statsFilter === 4 ? 'active' : ''}" onclick="setFilter('stats',4)">4 pelaajaa</button>
          <button class="filter-btn ${ui.statsFilter === 5 ? 'active' : ''}" onclick="setFilter('stats',5)">5 pelaajaa</button>
          <button class="filter-btn ${ui.statsFilter === 6 ? 'active' : ''}" onclick="setFilter('stats',6)">6 pelaajaa</button>
        </div>
      </div>
    </div>
    <div id="stats-content"></div>`;

  renderCategoriesContent();
}

function renderCategoriesContent() {
  const el = document.getElementById('stats-content');
  if (!el) return;

  const games = buildFilteredGames(ui.statsFilter);
  if (!games.length) { el.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">Ei ${ui.statsFilter} pelaajan pelej√§.</div></div>`; return; }

  const playerNames = [...new Set(games.flatMap(g => (g.scores || []).map(s => s.player)))];
  const cats        = SCORE_FIELDS.filter(f => f.key !== 'total');

  // Collect arrays per player per field
  const data = {};
  playerNames.forEach(p => { data[p] = {}; cats.forEach(c => data[p][c.key] = []); });
  games.forEach(g => (g.scores || []).forEach(s => {
    if (!data[s.player]) return;
    cats.forEach(c => { if (s[c.key] != null) data[s.player][c.key].push(s[c.key]); });
  }));

  // Total scores per player
  const totalData = playerNames.map(player => {
    const arr = games.flatMap(g => (g.scores || []).filter(s => s.player === player).map(s => s.total || 0));
    return { player, avg: arr.reduce((a, b) => a + b, 0) / (arr.length || 1), med: median(arr), max: arr.length ? Math.max(...arr) : 0, min: arr.length ? Math.min(...arr) : 0, sum: arr.reduce((a, b) => a + b, 0) };
  });

  const totalCard = `
    <div class="card" style="margin-bottom:20px">
      <div class="card-title">‚≠ê Yhteenlasketut pisteet</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px">
        ${buildStatCol(totalData, p => p.avg, ps => Math.max(...ps.map(p => p.avg), 1), 'Keskiarvo')}
        ${buildStatCol(totalData, p => p.med, ps => Math.max(...ps.map(p => p.med), 1), 'Mediaani', { opacity: 0.7 })}
        ${buildStatCol(totalData, p => p.max, ps => Math.max(...ps.map(p => p.max), 1), 'Isoin',    { opacity: 0.5, valStyle: 'color:var(--gold)' })}
        ${buildStatCol(totalData, p => p.min, ps => Math.max(...ps.map(p => p.min), 1), 'Pienin',   { opacity: 0.4, valStyle: 'color:var(--muted)' })}
        ${buildStatCol(totalData, p => p.sum, ps => Math.max(...ps.map(p => p.sum), 1), 'Pisteit√§ yhteens√§', { valStyle: 'color:var(--mars2)' })}
      </div>
    </div>`;

  // Category cards ‚Äî one per non-zero category
  const catCards = cats.map(cat => {
    const players = playerNames.map(player => {
      const arr = data[player][cat.key];
      return { player, avg: arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0, med: median(arr), max: arr.length ? Math.max(...arr) : 0 };
    });
    if (players.every(p => p.avg === 0)) return ''; // auto-hide empty

    return `
      <div class="stats-card">
        <div class="stats-card-title"><span>${cat.icon}</span>${cat.label}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          ${buildStatCol(players, p => p.avg, ps => Math.max(...ps.map(p => p.avg), 1), 'Keskiarvo')}
          ${buildStatCol(players, p => p.med, ps => Math.max(...ps.map(p => p.med), 1), 'Mediaani', { opacity: 0.7 })}
          ${buildStatCol(players, p => p.max, ps => Math.max(...ps.map(p => p.max), 1), 'Isoin',    { opacity: 0.5, valStyle: 'color:var(--gold)' })}
        </div>
      </div>`;
  }).filter(Boolean).join('');

  const label = ui.statsFilter === 0 ? `Kaikki pelit (${games.length})` : `${ui.statsFilter} pelaajan pelit (${games.length})`;
  el.innerHTML = catCards
    ? `<div class="card" style="margin-bottom:12px"><div style="font-size:12px;color:var(--muted)">üìä ${label}</div></div>${totalCard}<div class="stats-grid">${catCards}</div>`
    : `<div class="empty"><div class="empty-icon">üìä</div><div class="empty-text">Ei tarpeeksi dataa.</div></div>`;
}

// ============================================================
// ADD FORM
// ============================================================
function renderAddForm() {
  const dateEl = document.getElementById('inp-date');
  if (!dateEl.value) dateEl.value = new Date().toISOString().split('T')[0];
  const nextNum = state.games.length ? Math.max(...state.games.map(g => g.game_num || 0)) + 1 : 1;
  document.getElementById('inp-gamenum-display').textContent = `Peli #${nextNum}`;

  EXPANSIONS.forEach(exp => document.getElementById('exp-' + exp.key)?.classList.toggle('selected', form.expansions.includes(exp.key)));

  const mg = document.getElementById('map-grid');
  if (mg) mg.innerHTML = MAPS.map(m => `
    <div class="preset-btn ${form.map === m.key ? 'selected' : ''}" onclick="selectMap('${m.key}')">
      <span>${m.icon}</span><span>${m.label}</span>
    </div>`).join('');

  const rp = document.getElementById('random-presets');
  if (rp) {
    rp.style.display = form.map === 'Random' ? 'block' : 'none';
    if (form.map === 'Random') rp.innerHTML = `
      <div class="field-label" style="margin:10px 0 8px">Random-kartan asetus</div>
      <div class="preset-grid">
        ${RANDOM_PRESETS.map(p => `
          <div class="preset-btn ${form.mapPreset === p.key ? 'selected' : ''}" onclick="selectRandomPreset('${p.key}')">
            <span>${p.icon}</span><span>${p.label}</span>
          </div>`).join('')}
      </div>`;
  }

  const playerEl = document.getElementById('player-select');
  if (playerEl) playerEl.innerHTML = state.players.map(p => {
    const name = p.name || p;
    const idx  = form.players.indexOf(name);
    const sel  = idx !== -1;
    const badge = sel ? `<span style="background:rgba(255,255,255,0.2);border-radius:10px;padding:1px 6px;font-size:11px;font-weight:700">${idx + 1}</span>` : '';
    return `<div class="player-chip ${sel ? 'selected' : ''}" onclick="toggleFormPlayer('${name}')"><div class="dot"></div>${name}${badge}</div>`;
  }).join('');

  renderScoreSections();
}

function toggleFormPlayer(name) {
  form.players = form.players.includes(name) ? form.players.filter(x => x !== name) : [...form.players, name];
  renderAddForm();
}

async function addPlayer() {
  const inp  = document.getElementById('new-player-name');
  const name = inp.value.trim();
  if (!name || state.players.find(p => (p.name || p) === name)) { inp.value = ''; return; }
  const color = PLAYER_COLORS[state.players.length % PLAYER_COLORS.length];
  const { error } = await sb.from('players').insert({ name, color });
  if (error) { showToast('Virhe pelaajan lis√§√§misess√§', 'error'); return; }
  await loadData();
  form.players.push(name);
  inp.value = '';
  renderAddForm();
}

function renderScoreSections() {
  const el = document.getElementById('score-sections');
  if (!el) return;
  el.innerHTML = form.players.map(p => `
    <div class="score-block">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        ${buildAvatar(p, 'sm')}
        <strong>${p}</strong>
        <span style="margin-left:auto;font-size:12px;color:var(--muted)">Total: <span id="td-${p}" style="color:var(--mars2);font-family:'Orbitron',monospace;font-weight:700">0</span></span>
      </div>
      <div class="form-grid">
        ${SCORE_FIELDS.filter(f => f.key !== 'total').map(f => `
          <div class="field-group">
            <div class="field-label">${f.icon} ${f.label}</div>
            <input class="field-input" type="number" id="sc-${p}-${f.key}" placeholder="0" min="0" oninput="calcScoreTotal('sc','${p}')">
          </div>`).join('')}
        <div class="field-group">
          <div class="field-label">‚≠ê Total</div>
          <input class="field-input" type="number" id="sc-${p}-total" readonly style="border-color:var(--mars);font-weight:700;font-family:'Orbitron',monospace;font-size:17px;cursor:default;opacity:0.85" value="0">
        </div>
      </div>
    </div>`).join('');
}

function calcScoreTotal(prefix, player) {
  const sum = SCORE_FIELDS.filter(f => f.key !== 'total')
    .reduce((acc, f) => acc + (parseInt(document.getElementById(`${prefix}-${player}-${f.key}`)?.value) || 0), 0);
  const el = document.getElementById(`${prefix}-${player}-total`);
  if (el) el.value = sum;
}

function toggleExpansion(key) {
  form.expansions = form.expansions.includes(key) ? form.expansions.filter(x => x !== key) : [...form.expansions, key];
  EXPANSIONS.forEach(exp => document.getElementById('exp-' + exp.key)?.classList.toggle('selected', form.expansions.includes(exp.key)));
}

function selectMap(key)         { form.map = form.map === key ? null : key; form.mapPreset = null; renderAddForm(); }
function selectRandomPreset(key){ form.mapPreset = form.mapPreset === key ? null : key; renderAddForm(); }

async function saveGame() {
  if (!form.players.length) { showToast('Valitse pelaajat!', 'error'); return; }
  const btn        = document.getElementById('save-game-btn');
  btn.disabled     = true;
  const date       = document.getElementById('inp-date').value || null;
  const generation = parseInt(document.getElementById('inp-generation').value) || null;
  const nextNum    = state.games.length ? Math.max(...state.games.map(g => g.game_num || 0)) + 1 : 1;

  const { data: gameData, error: gameErr } = await sb.from('games').insert({
    game_num: nextNum, date, generation,
    expansions: form.expansions,
    map_type:   form.map,
    map_preset: form.map === 'Random' ? form.mapPreset : null,
  }).select().single();

  if (gameErr) { showToast('Virhe pelin tallentamisessa', 'error'); btn.disabled = false; return; }

  const scoreRows = form.players.map((p, i) => ({
    game_id: gameData.id, player_name: p, turn_order: i,
    ...Object.fromEntries(SCORE_FIELDS.map(f => [f.key, parseInt(document.getElementById(`sc-${p}-${f.key}`)?.value) || 0])),
  }));

  const { error: scoreErr } = await sb.from('scores').insert(scoreRows);
  if (scoreErr) { showToast('Virhe pisteiden tallentamisessa', 'error'); btn.disabled = false; return; }

  showToast('Peli tallennettu! ‚úì');
  clearForm();
  await refreshAndRender();
  btn.disabled = false;
  showTab('games');
}

function clearForm() {
  form.players = []; form.expansions = []; form.map = null; form.mapPreset = null;
  const g = document.getElementById('inp-generation'); if (g) g.value = '';
  const d = document.getElementById('inp-date');       if (d) d.value = '';
  renderAddForm();
}

// ============================================================
// EDIT GAME
// ============================================================
let editingId = null;

function editGame(id) {
  const g = state.games.find(x => x.id === id);
  if (!g) return;
  editingId = id;
  const scores = g.scores || [];

  document.getElementById('edit-modal-content').innerHTML = `
    <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:14px">
      <div class="field-group"><div class="field-label">P√§iv√§m√§√§r√§</div>
        <input class="field-input" type="date" id="edit-date" value="${g.date || ''}"></div>
      <div class="field-group"><div class="field-label">Pelinumero</div>
        <input class="field-input" type="number" id="edit-gamenum" value="${g.game_num || ''}"></div>
      <div class="field-group"><div class="field-label">üåç Sukupolvi</div>
        <input class="field-input" type="number" id="edit-generation" placeholder="esim. 12" min="1" max="30" value="${g.generation || ''}"></div>
    </div>
    <div style="margin-bottom:14px">
      <div class="field-label" style="margin-bottom:8px">Lis√§osat</div>
      <div class="expansion-row">
        ${EXPANSIONS.map(exp => `
          <div class="exp-chip ${exp.cls} ${(g.expansions || []).includes(exp.key) ? 'selected' : ''}"
               id="edit-exp-${exp.key}" onclick="this.classList.toggle('selected')">
            ${exp.icon} ${exp.label}
          </div>`).join('')}
      </div>
    </div>
    <div style="margin-bottom:14px">
      <div class="field-label" style="margin-bottom:8px">Kartta</div>
      <div class="preset-grid">
        ${MAPS.map(m => `
          <div class="preset-btn ${g.map_type === m.key ? 'selected' : ''}" id="edit-map-${m.key}" onclick="selectEditMap('${m.key}')">
            <span>${m.icon}</span><span>${m.label}</span>
          </div>`).join('')}
      </div>
      <div id="edit-random-presets" style="${g.map_type === 'Random' ? 'margin-top:10px' : 'display:none;margin-top:10px'}">
        <div class="field-label" style="margin-bottom:8px">Random-kartan asetus</div>
        <div class="preset-grid">
          ${RANDOM_PRESETS.map(p => `
            <div class="preset-btn ${g.map_preset === p.key ? 'selected' : ''}" id="edit-preset-${p.key}" onclick="selectEditPreset('${p.key}')">
              <span>${p.icon}</span><span>${p.label}</span>
            </div>`).join('')}
        </div>
      </div>
    </div>
    ${scores.map(s => `
      <div class="score-block">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          ${buildAvatar(s.player, 'sm')} <strong>${s.player}</strong>
        </div>
        <div class="form-grid">
          ${SCORE_FIELDS.filter(f => f.key !== 'total').map(f => `
            <div class="field-group">
              <div class="field-label">${f.label}</div>
              <input class="field-input" type="number" id="edit-${s.player}-${f.key}" value="${s[f.key] ?? 0}" oninput="calcScoreTotal('edit','${s.player}')">
            </div>`).join('')}
          <div class="field-group">
            <div class="field-label">‚≠ê Total</div>
            <input class="field-input" type="number" id="edit-${s.player}-total" readonly style="border-color:var(--mars);font-weight:700;font-family:'Orbitron',monospace;font-size:17px;cursor:default;opacity:0.85" value="${s.total ?? 0}">
          </div>
        </div>
      </div>`).join('')}`;

  document.getElementById('edit-modal').classList.add('show');
}

function selectEditMap(key) {
  document.querySelectorAll('[id^="edit-map-"]').forEach(el => el.classList.remove('selected'));
  document.getElementById('edit-map-' + key)?.classList.add('selected');
  const rp = document.getElementById('edit-random-presets');
  if (rp) rp.style.display = key === 'Random' ? 'block' : 'none';
  if (key !== 'Random') document.querySelectorAll('[id^="edit-preset-"]').forEach(el => el.classList.remove('selected'));
}

function selectEditPreset(key) {
  document.querySelectorAll('[id^="edit-preset-"]').forEach(el => el.classList.remove('selected'));
  document.getElementById('edit-preset-' + key)?.classList.add('selected');
}

// calcScoreTotal handles both add and edit forms

async function saveEdit() {
  const g = state.games.find(x => x.id === editingId);
  if (!g) return;

  const { error: gameErr } = await sb.from('games').update({
    date:       document.getElementById('edit-date').value || null,
    game_num:   parseInt(document.getElementById('edit-gamenum').value) || g.game_num,
    generation: parseInt(document.getElementById('edit-generation').value) || null,
    expansions: EXPANSIONS.filter(exp => document.getElementById('edit-exp-' + exp.key)?.classList.contains('selected')).map(e => e.key),
    map_type:   MAPS.find(m => document.getElementById('edit-map-' + m.key)?.classList.contains('selected'))?.key || null,
    map_preset: RANDOM_PRESETS.find(p => document.getElementById('edit-preset-' + p.key)?.classList.contains('selected'))?.key || null,
  }).eq('id', editingId);

  if (gameErr) { showToast('Virhe tallentamisessa', 'error'); return; }

  await Promise.all((g.scores || []).map(s => {
    const updates = Object.fromEntries(
      SCORE_FIELDS.map(f => [f.key, parseInt(document.getElementById(`edit-${s.player}-${f.key}`)?.value) || 0])
    );
    return sb.from('scores').update(updates).eq('game_id', editingId).eq('player_name', s.player);
  }));

  showToast('Muutokset tallennettu ‚úì');
  closeModal();
  await refreshAndRender();
}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('show');
  editingId = null;
}

// ============================================================
// INIT
// ============================================================
async function init() {
  document.getElementById('ranking-list').innerHTML = '<div class="loading"><div class="spinner"></div>Ladataan...</div>';
  await initAuth();
  await loadData();
  renderRanking();
}

init();
</script>
</body>
</html>
